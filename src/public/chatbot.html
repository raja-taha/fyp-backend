<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .chatbot-container { width: 350px; border: 1px solid #ccc; border-radius: 8px; padding: 20px; }
        .hidden { display: none; }
        .input-field { width: 100%; padding: 8px; margin: 5px 0; }
        .button { width: 100%; padding: 10px; background: blue; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <div id="chat-screen">
            <h3>Chatbot</h3>
            <div id="chatbox"></div>
            <form id="messageForm">
                <input type="text" id="chat-input" class="input-field" placeholder="Type a message...">
                <button type="submit" class="button">Send</button>
            </form>
            <button class="button" onclick="logout()" style="background: red;">Logout</button>
        </div>
    </div>
    <script src="/config.js"></script>
    <script>
        const socket = io(window.APP_CONFIG.BACKEND_URL);
        let clientId = null;
        let agentId = null;

        function getCookie(name) {
            const cookies = document.cookie.split("; ");
            for (let cookie of cookies) {
                let [key, value] = cookie.split("=");
                if (key === name) return decodeURIComponent(value);
            }
            return null;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const clientUserCookie = getCookie("clientUser");
            if (clientUserCookie) {
                try {
                    const clientUser = JSON.parse(clientUserCookie);
                    clientId = clientUser.id;
                    agentId = clientUser.assignedAgent?.id || null;
                    if (clientId && agentId) {
                        socket.emit("joinRoom", { userId: clientId });
                        loadChatHistory();
                    }
                } catch (error) {
                    console.error("Error parsing clientUser cookie:", error);
                }
            }
        });

        async function loadChatHistory() {
            if (!clientId || !agentId) return;
            const response = await fetch(`/api/chats/messages?clientId=${clientId}&agentId=${agentId}`);
            const chatSession = await response.json();

            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = "";

            chatSession.forEach(msg => {
                chatbox.innerHTML += `<p><b>${msg.sender === "client" ? "You" : "Agent"}:</b> ${msg.text}</p>`;
            });
        }

        document.getElementById("messageForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById("chat-input");
            const text = messageInput.value.trim();
            if (!text || !clientId || !agentId) return;

            const messageData = { clientId, agentId, sender: "client", text };

            // document.getElementById("chatbox").innerHTML += `<p><b>You:</b> ${text}</p>`;
            messageInput.value = "";

            socket.emit("sendMessage", messageData);
            console.log(messageData);
            
            try {
                await fetch("/api/chats/message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(messageData),
                });
            } catch (error) {
                console.error("Error:", error);
            }
        });

        socket.on("newMessage", (msg) => {
            document.getElementById("chatbox").innerHTML += `<p><b>${msg.sender === "client" ? "You" : "Agent"}:</b> ${msg.text}</p>`;
        });
    </script>
</body>
</html>
