<!-- Modified HTML (chatbot.html) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${chatbot.name || "LinguistLink"}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Add a script to define chatbotId globally -->
    <script>
      // This will be replaced by the server with the actual chatbotId
      window.APP_CONFIG = {
        CHATBOT_ID: "${chatbotId}",
        BACKEND_URL: window.location.origin
      };
    </script>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* Voice recording styles */
      .mic-btn {
        background: none;
        border: none;
        color: #505050;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        transition: color 0.3s;
      }
      .mic-btn:hover {
        color: #0084ff;
      }
      .mic-btn.recording {
        color: #ff3b30;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      .recording-timer {
        font-size: 0.8rem;
        color: #ff3b30;
        margin-left: 8px;
        display: none;
      }
      .recording-timer.active {
        display: inline-block;
      }
      .voice-message {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .voice-message audio {
        max-width: 200px;
        height: 40px;
      }
      .voice-controls {
        display: flex;
        align-items: center;
      }
      .voice-message-container {
        background-color: rgba(43, 127, 255, 0.9) !important;
      }
      .voice-message-container audio {
        border-radius: 8px;
        outline: none;
      }
      .agent-message.voice-message-container {
        background-color: rgba(238, 238, 238, 0.9) !important;
      }
    </style>
  </head>
  <body>
    <div class="chatbot-container">
      <!-- Chat Screen -->
      <div id="chat-screen" class="hidden">
        <div class="header">
          <div class="logo">
            <img src="/robot-logo.svg" alt="Logo">
            <span id="chatbot-name"></span>
            <span id="user-language" class="language-badge"></span>
          </div>
          <button class="close-btn">&times;</button>
        </div>
        <div id="chatbox"></div>
        <form id="message-form">
          <div class="voice-controls">
            <button type="button" id="voice-record-btn" class="mic-btn">
              <i class="fas fa-microphone"></i>
            </button>
            <span id="recording-timer" class="recording-timer">0:00</span>
          </div>
          <input
            type="text"
            id="chat-input"
            placeholder="Type your message here..."
          />
          <button type="submit" id="send-button">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>

      <!-- Login Screen -->
      <div id="login-screen">
        <div class="header">
          <div class="logo">
            <img src="/robot-logo.svg" alt="Logo">
            <span id="login-chatbot-name"></span>
          </div>
          <button class="close-btn">&times;</button>
        </div>
        <div class="login-container">
          <h2>Login</h2>
          <div class="language-selector">
            <label for="language">Select Language:</label>
            <select id="language" class="input-field">
              <option value="english">English</option>
              <option value="spanish">Spanish</option>
              <option value="french">French</option>
              <option value="chinese">Chinese</option>
              <option value="hindi">Hindi</option>
              <option value="arabic">Arabic</option>
              <option value="portuguese">Portuguese</option>
              <option value="bengali">Bengali</option>
              <option value="russian">Russian</option>
              <option value="japanese">Japanese</option>
              <option value="german">German</option>
              <option value="korean">Korean</option>
              <option value="italian">Italian</option>
              <option value="turkish">Turkish</option>
              <option value="urdu">Urdu</option>
            </select>
          </div>
          <form id="loginForm">
            <input
              type="email"
              id="login-email"
              class="input-field"
              placeholder="Email"
              required
            />
            <input
              type="password"
              id="login-password"
              class="input-field"
              placeholder="Password"
              required
            />
            <button type="submit" class="button">Login</button>
          </form>
          <p class="link-text">
            Don't have an account? <a class="link" onclick="showSignup()">Sign Up</a>
          </p>
        </div>
      </div>

      <!-- Signup Screen -->
      <div id="signup-screen" class="hidden">
        <div class="header">
          <div class="logo">
            <img src="/robot-logo.svg" alt="Logo">
            <span id="signup-chatbot-name"></span>
          </div>
          <button class="close-btn">&times;</button>
        </div>
        <div class="signup-container">
          <h2>Signup</h2>
          <div class="language-selector">
            <label for="signup-language">Select Language:</label>
            <select id="signup-language" class="input-field">
              <option value="english">English</option>
              <option value="spanish">Spanish</option>
              <option value="french">French</option>
              <option value="chinese">Chinese</option>
              <option value="hindi">Hindi</option>
              <option value="arabic">Arabic</option>
              <option value="portuguese">Portuguese</option>
              <option value="bengali">Bengali</option>
              <option value="russian">Russian</option>
              <option value="japanese">Japanese</option>
              <option value="german">German</option>
              <option value="korean">Korean</option>
              <option value="italian">Italian</option>
              <option value="turkish">Turkish</option>
              <option value="urdu">Urdu</option>
            </select>
          </div>
          <form id="signupForm">
            <input
              type="email"
              id="signup-email"
              class="input-field"
              placeholder="Email"
              required
            />
            <input
              type="text"
              id="signup-firstname"
              class="input-field"
              placeholder="First Name"
              required
            />
            <input
              type="text"
              id="signup-lastname"
              class="input-field"
              placeholder="Last Name"
              required
            />
            <input
              type="password"
              id="signup-password"
              class="input-field"
              placeholder="Password"
              required
            />
            <input
              type="password"
              id="signup-confirm-password"
              class="input-field"
              placeholder="Confirm Password"
              required 
            />
            <input
              type="text"
              id="signup-phone"
              class="input-field"
              placeholder="Phone Number"
              required
            />
            <button type="submit" class="button">Signup</button>
          </form>
          <p class="link-text">
            Already have an account? <a class="link" onclick="showLogin()">Login</a>
          </p>
        </div>
      </div>
    </div>

    <script>
      const socket = io(window.APP_CONFIG.BACKEND_URL);
      let clientId = null;
      let agentId = null;
      let currentLanguage = "english"; // Default language
      let chatbotName = "LinguistLink"; // Default name until we fetch the real one
      
      // Voice recording variables
      let mediaRecorder;
      let audioChunks = [];
      let recordingStartTime;
      let recordingTimer;
      let isRecording = false;

      function getStoredData(key) {
        try {
          return JSON.parse(localStorage.getItem(key));
        } catch (error) {
          console.error(`Error retrieving ${key} from localStorage:`, error);
          return null;
        }
      }

      function storeData(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
          console.error(`Error storing ${key} in localStorage:`, error);
        }
      }

      // For backward compatibility - migrate any existing cookies to localStorage
      function migrateFromCookies() {
        const clientUserCookie = getCookie("clientUser");
        const savedLanguage = getCookie("clientLanguage");
        
        if (clientUserCookie && !getStoredData("clientUser")) {
          try {
            storeData("clientUser", JSON.parse(clientUserCookie));
            // Clear the old cookie
            document.cookie = "clientUser=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          } catch (e) {
            console.error("Error migrating client user cookie:", e);
          }
        }
        
        if (savedLanguage && !getStoredData("clientLanguage")) {
          storeData("clientLanguage", savedLanguage);
          // Clear the old cookie
          document.cookie = "clientLanguage=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }
      }

      function getCookie(name) {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
          let [key, value] = cookie.split("=");
          if (key === name) return decodeURIComponent(value);
        }
        return null;
      }

      function setCookie(name, value, days) {
        // Store in localStorage instead
        storeData(name, value);
      }

      // Fetch chatbot details and set name
      async function fetchChatbotName() {
        try {
          const chatbotId = window.APP_CONFIG.CHATBOT_ID;
          if (!chatbotId || chatbotId.includes("${")) {
            console.error("Invalid chatbotId format:", chatbotId);
            return;
          }
          
          const response = await fetch(`/api/chatbots/public/${chatbotId}`);
          if (response.ok) {
            const data = await response.json();
            chatbotName = data.name || "LinguistLink";
            setChatbotName();
          } else {
            console.error("Failed to fetch chatbot details");
          }
        } catch (error) {
          console.error("Error fetching chatbot details:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Migrate any existing cookies to localStorage
        migrateFromCookies();
        
        // Fetch and set chatbot name
        fetchChatbotName();
        setChatbotName(); // Set default name initially
        
        // Initialize voice recording
        initVoiceRecording();
        
        const clientUser = getStoredData("clientUser");
        const savedLanguage = getStoredData("clientLanguage") || "english";
        currentLanguage = savedLanguage;
        
        // Set the language badge in the header
        updateLanguageBadge(currentLanguage);
        
        // Set the language dropdown values
        if (document.getElementById("language")) {
          document.getElementById("language").value = savedLanguage;
        }
        if (document.getElementById("signup-language")) {
          document.getElementById("signup-language").value = savedLanguage;
        }
        
        if (clientUser) {
          try {
            clientId = clientUser.id;
            agentId = clientUser.assignedAgent?.id || null;
            if (clientId && agentId) {
              socket.emit("joinRoom", { userId: clientId, language: savedLanguage });
              loadChatHistory();
              // Ensure the chat screen is displayed
              document.getElementById("chat-screen").classList.remove("hidden");
              document.getElementById("signup-screen").classList.add("hidden");
              document.getElementById("login-screen").classList.add("hidden");
            } else {
              console.error("Invalid client or agent ID in stored data");
              showLogin();
            }
          } catch (error) {
            console.error("Error parsing stored client user data:", error);
            showLogin();
          }
        } else {
          showLogin();
        }
      });

      async function loadChatHistory() {
        if (!clientId || !agentId) return;
        const response = await fetch(
          `/api/chats/messages?clientId=${clientId}&agentId=${agentId}`
        );
        const chatSession = await response.json();

        const chatbox = document.getElementById("chatbox");
        chatbox.innerHTML = "";

        if (
          chatSession.message === "No messages found" ||
          chatSession.length === 0
        ) {
          chatbox.innerHTML =
            "<p class='no-messages'>No messages yet. Start chatting with your agent!</p>";
        } else {
          // Group messages by date
          const messagesByDate = {};
          const today = new Date().toDateString();
          
          chatSession.forEach((msg) => {
            const msgDate = new Date(msg.timestamp).toDateString();
            if (!messagesByDate[msgDate]) {
              messagesByDate[msgDate] = [];
            }
            messagesByDate[msgDate].push(msg);
          });
          
          // Sort dates in chronological order
          const sortedDates = Object.keys(messagesByDate).sort((a, b) => 
            new Date(a) - new Date(b)
          );
          
          // Render messages grouped by date
          sortedDates.forEach(date => {
            // Add date separator
            const dateDisplay = date === today ? "Today" : formatDateSeparator(date);
            chatbox.innerHTML += `<div class="date-separator" data-date="${date}"><span>${dateDisplay}</span></div>`;
            
            // Add messages for this date
            messagesByDate[date].forEach(msg => {
              const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
              const messageClass = msg.sender === "client" ? "client-message" : "agent-message";
              
              // Determine which message to display
              let primaryText, secondaryText;
              
              if (msg.sender === "agent") {
                // For agent messages, show translatedText as primary (in client's language)
                primaryText = msg.translatedText || msg.text;
                secondaryText = msg.text;
              } else {
                // For client messages, show original text as primary
                primaryText = msg.text;
                secondaryText = msg.translatedText || msg.text;
              }
              
              // Display message with translation toggle
              chatbox.innerHTML += `
                <div class="message ${messageClass}${msg.isVoiceMessage ? ' voice-message-container' : ''}">
                  <div class="message-content">
                    <div class="primary-text">${primaryText}</div>
                    <div class="secondary-text hidden">${secondaryText}</div>
                    ${primaryText !== secondaryText ? 
                      `<button class="translation-toggle" onclick="toggleTranslation(this)">
                        <i class="fas fa-language"></i>
                      </button>` : ''}
                  </div>
                  <span class="message-time">${time}</span>
                </div>
              `;
            });
          });
          
          // Scroll to bottom of chat
          chatbox.scrollTop = chatbox.scrollHeight;
        }
      }

      // Format date for separator
      function formatDateSeparator(dateString) {
        const date = new Date(dateString);
        const options = { weekday: 'short', month: 'short', day: 'numeric' };
        return date.toLocaleDateString(undefined, options);
      }

      // Initialize voice recording functionality
      function initVoiceRecording() {
        const recordButton = document.getElementById("voice-record-btn");
        const recordingTimerElement = document.getElementById("recording-timer");
        
        // Request microphone access
        recordButton.addEventListener("click", async () => {
          if (!isRecording) {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              startRecording(stream);
              recordButton.classList.add("recording");
              recordingTimerElement.classList.add("active");
              isRecording = true;
              
              // Start recording timer
              recordingStartTime = Date.now();
              recordingTimer = setInterval(updateRecordingTimer, 1000);
            } catch (error) {
              console.error("Error accessing microphone:", error);
              alert("Unable to access your microphone. Please check your browser permissions.");
            }
          } else {
            stopRecording();
            recordButton.classList.remove("recording");
            recordingTimerElement.classList.remove("active");
            isRecording = false;
            clearInterval(recordingTimer);
          }
        });
      }
      
      function startRecording(stream) {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });
        
        mediaRecorder.addEventListener("stop", async () => {
          // Convert audio chunks to blob
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          
          // Create FormData and append audio blob
          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.webm");
          formData.append("clientId", clientId);
          formData.append("agentId", agentId);
          formData.append("sender", "client");
          formData.append("timestamp", new Date().toISOString());
          formData.append("saveMessage", "true");
          
          try {
            // Upload the audio file
            const response = await fetch("/api/chats/voice-message", {
              method: "POST",
              body: formData
            });
            
            if (!response.ok) {
              throw new Error("Failed to upload voice message");
            }
            
            const result = await response.json();
            
            // We don't need to send a separate socket message as the server will handle it
            console.log("Voice message uploaded successfully:", result);
            
          } catch (error) {
            console.error("Error sending voice message:", error);
            alert("Failed to send voice message. Please try again.");
          }
          
          // Stop all tracks on the stream to release the microphone
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        });
        
        // Start recording
        mediaRecorder.start();
      }
      
      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      }
      
      function updateRecordingTimer() {
        const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        document.getElementById("recording-timer").textContent = 
          `${minutes}:${seconds.toString().padStart(2, "0")}`;
          
        // Auto-stop recording after 2 minutes
        if (elapsedSeconds >= 120) {
          document.getElementById("voice-record-btn").click();
        }
      }

      document
        .getElementById("message-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const messageInput = document.getElementById("chat-input");
          const text = messageInput.value.trim();
          if (!text || !clientId || !agentId) return;

          const messageData = { 
            clientId, 
            agentId, 
            sender: "client", 
            text,
            timestamp: new Date().toISOString()
          };

          // Clear input field
          messageInput.value = "";

          // Send the message via socket.io
          socket.emit("sendMessage", messageData);
          console.log("Message sent:", messageData);
        });

      socket.on("newMessage", (msg) => {
        const chatbox = document.getElementById("chatbox");
        
        // Remove the "no messages" message if it exists
        const noMessagesElement = chatbox.querySelector('.no-messages');
        if (noMessagesElement) {
          noMessagesElement.remove();
        }
        
        const msgDate = new Date(msg.timestamp).toDateString();
        const today = new Date().toDateString();
        
        // Check if we need to add a date separator by looking for existing one with same date
        const existingSeparator = chatbox.querySelector(`.date-separator[data-date="${msgDate}"]`);
        
        if (!existingSeparator) {
          const dateDisplay = msgDate === today ? "Today" : formatDateSeparator(msgDate);
          chatbox.innerHTML += `<div class="date-separator" data-date="${msgDate}"><span>${dateDisplay}</span></div>`;
        }
        
        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const messageClass = msg.sender === "client" ? "client-message" : "agent-message";
        
        // Determine which message to display
        let primaryText, secondaryText;
        
        if (msg.sender === "agent") {
          // For agent messages, show translatedText as primary (in client's language)
          primaryText = msg.translatedText || msg.text;
          secondaryText = msg.text;
        } else {
          // For client messages, show original text as primary
          primaryText = msg.text;
          secondaryText = msg.translatedText || msg.text;
        }
        
        // Display message with translation toggle
        chatbox.innerHTML += `
          <div class="message ${messageClass}${msg.isVoiceMessage ? ' voice-message-container' : ''}">
            <div class="message-content">
              <div class="primary-text">${primaryText}</div>
              <div class="secondary-text hidden">${secondaryText}</div>
              ${primaryText !== secondaryText ? 
                `<button class="translation-toggle" onclick="toggleTranslation(this)">
                  <i class="fas fa-language"></i>
                </button>` : ''}
            </div>
            <span class="message-time">${time}</span>
          </div>
        `;
        
        // Scroll to bottom after new message
        chatbox.scrollTop = chatbox.scrollHeight;
      });

      function showSignup() {
        // Transfer the selected language from login to signup
        const loginLanguage = document.getElementById("language").value;
        document.getElementById("signup-screen").classList.remove("hidden");
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("chat-screen").classList.add("hidden");
        
        // Set the language dropdown to match the login screen
        document.getElementById("signup-language").value = loginLanguage;
      }

      function showLogin() {
        // Transfer the selected language from signup to login
        const signupLanguage = document.getElementById("signup-language")?.value;
        document.getElementById("signup-screen").classList.add("hidden");
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("chat-screen").classList.add("hidden");
        
        // Set the language dropdown to match the signup screen if it exists
        if (signupLanguage) {
          document.getElementById("language").value = signupLanguage;
        }
      }

      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("signup-email").value.trim();
          const firstName = document.getElementById("signup-firstname").value.trim();
          const lastName = document.getElementById("signup-lastname").value.trim();
          const password = document.getElementById("signup-password").value.trim();
          const confirmPassword = document.getElementById("signup-confirm-password").value.trim();
          const phone = document.getElementById("signup-phone").value.trim();
          const language = document.getElementById("signup-language").value;
          const chatbotId = window.APP_CONFIG.CHATBOT_ID;

          if (!firstName || !lastName || !email || !password || !confirmPassword || !phone || !chatbotId) {
            alert("All fields are required");
            return;
          }

          if (password !== confirmPassword) {
            alert("Passwords do not match");
            return;
          }

          if (!chatbotId) {
            console.error("ChatbotId is undefined");
            return;
          }

          const response = await fetch("/api/clients/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              firstName,
              lastName,
              email,
              password,
              confirmPassword,
              phone,
              chatbotId,
              language,
            }),
          });

          if (response.ok) {
            // Store the language preference but don't auto-login
            storeData("clientLanguage", language);
            
            // Clear signup form
            document.getElementById("signup-email").value = "";
            document.getElementById("signup-firstname").value = "";
            document.getElementById("signup-lastname").value = "";
            document.getElementById("signup-password").value = "";
            document.getElementById("signup-confirm-password").value = "";
            document.getElementById("signup-phone").value = "";
            
            // Show success message and redirect to login
            alert("Signup successful! Please login with your credentials.");
            
            // Populate the login email field with the email they just registered with
            document.getElementById("login-email").value = email;
            
            // Redirect to login screen
            showLogin();
          } else {
            const error = await response.json();
            alert(error.message || "Signup failed. Please try again.");
            console.error("Signup failed", error);
          }
        });

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("login-email").value.trim();
          const password = document.getElementById("login-password").value.trim();
          const language = document.getElementById("language").value;
          const chatbotId = window.APP_CONFIG.CHATBOT_ID;

          const response = await fetch("/api/clients/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, chatbotId, language }),
          });

          if (response.ok) {
            const data = await response.json();
            storeData("clientUser", data.client);
            storeData("clientLanguage", language);
            currentLanguage = language;
            updateLanguageBadge(language);

            clientId = data.client.id;
            agentId = data.client.assignedAgent?.id || null;

            socket.emit("joinRoom", { userId: clientId, language });
            await loadChatHistory();

            document.getElementById("chat-screen").classList.remove("hidden");
            document.getElementById("signup-screen").classList.add("hidden");
            document.getElementById("login-screen").classList.add("hidden");
          } else {
            alert("Login failed. Please check your credentials.");
            console.error("Login failed", response);
          }
        });

      // Close button functionality
      document.querySelectorAll('.close-btn').forEach(button => {
        button.addEventListener('click', function() {
          // Send a message to the parent window to close the iframe
          try {
            window.parent.postMessage("close", "*");
            console.log("Close message sent to parent window");
            
            // Instead of hiding the elements, just show the login screen
            // This keeps the DOM structure intact for reopening
            showLogin();
          } catch (error) {
            console.error("Error sending close message:", error);
          }
        });
      });

      function logout() {
        // Clear the stored data
        localStorage.removeItem("clientUser");
        // Redirect to the login screen
        showLogin();
      }

      function updateLanguageBadge(language) {
        const languageBadge = document.getElementById("user-language");
        if (languageBadge) {
          // Capitalize first letter of language
          const displayLanguage = language.charAt(0).toUpperCase() + language.slice(1);
          languageBadge.textContent = displayLanguage;
        }
      }

      // Set chatbot name in all headers
      function setChatbotName() {
        if (document.getElementById("chatbot-name")) {
          document.getElementById("chatbot-name").textContent = chatbotName;
        }
        if (document.getElementById("login-chatbot-name")) {
          document.getElementById("login-chatbot-name").textContent = chatbotName;
        }
        if (document.getElementById("signup-chatbot-name")) {
          document.getElementById("signup-chatbot-name").textContent = chatbotName;
        }
      }

      // Add translation toggle function at the end of the script section
      function toggleTranslation(button) {
        const messageContent = button.parentElement;
        const primaryText = messageContent.querySelector('.primary-text');
        const secondaryText = messageContent.querySelector('.secondary-text');
        
        // Swap visibility
        primaryText.classList.toggle('hidden');
        secondaryText.classList.toggle('hidden');
        
        // Change button icon to indicate state
        const icon = button.querySelector('i');
        if (primaryText.classList.contains('hidden')) {
          icon.className = 'fas fa-language';
          button.title = 'Show original message';
        } else {
          icon.className = 'fas fa-language';
          button.title = 'Show translated message';
        }
      }
    </script>
  </body>
</html>